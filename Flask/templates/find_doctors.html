<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Nearby Doctors</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <header>
        <nav>
            <div class="nav-left">
                <a href="{{ url_for('home') }}">Health Compass üß≠</a>
            </div>
            <div class="nav-right">
                <a href="{{ url_for('home') }}">Home</a>
                <a href="{{ url_for('tips') }}">Tips/Tricks</a>
                <a href="{{ url_for('doctors') }}">Doctors</a>
                <a href="{{ url_for('about') }}">About</a>
                <a href="{{ url_for('profile') }}">Profile</a>
                <a href="{{ url_for('logout') }}">Logout</a>
            </div>
        </nav>
    </header>

    <script>
        /* =======================
           OpenCage (Location Name)
        ======================== */
        const OPEN_CAGE_API_KEY = '2db64e1162a4418c9d25a0543286f343';
function reverseGeocode(lat, lon) {
    const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${OPEN_CAGE_API_KEY}`;

    return fetch(url)
        .then(res => res.json())
        .then(data => {
            if (!data.results || data.results.length === 0) {
                return "Location not found";
            }

            const comp = data.results[0].components;

            const area =
                comp.suburb ||
                comp.neighbourhood ||
                comp.village ||
                comp.town ||
                comp.city_district ||
                comp.city ||
                "Unknown Area";

            const city = comp.city || "Mumbai";
            const pincode = comp.postcode || "N/A";

            return `${area}, ${city} ‚Äì ${pincode}`;
        })
        .catch(() => "Location unavailable");
}


        /* =======================
           Get User Location
        ======================== */
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        async function showPosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const doctorType = document.querySelector('input[name="doctorType"]:checked').value;

            // Show city & pincode (OpenCage)
            const locationName = await reverseGeocode(lat, lon);
            document.getElementById("locationInfo").innerText =
                `Detected Location: ${locationName}`;

            // Fetch doctors via SerpAPI (Flask backend)
            fetchNearbyDoctors(doctorType, lat, lon);
        }

        function showError(error) {
            alert("Unable to fetch your location. Please allow location access.");
        }

        /* =======================
           Fetch Doctors (SerpAPI)
        ======================== */
        function fetchNearbyDoctors(type, lat, lon) {
            fetch(`/api/find_doctors?type=${type}&lat=${lat}&lon=${lon}`)
                .then(res => res.json())
                .then(data => {
                    const doctorsList = document.getElementById("doctorsList");
                    doctorsList.innerHTML = "";

                    if (!data || data.length === 0) {
                        doctorsList.innerHTML = "<li>No doctors found nearby.</li>";
                        return;
                    }

                    data.forEach(doc => {
                        const name = doc.title || "Doctor";
                        const address = doc.address || "Address not available";
                        const phone = doc.phone || "Not available";

                        const li = document.createElement("li");
                        li.innerHTML = `
                            <strong>${name}</strong><br>
                            Address: ${address}<br>
                            Contact: ${phone}
                        `;
                        doctorsList.appendChild(li);
                    });
                })
                .catch(() => {
                    alert("Unable to fetch doctors at the moment.");
                });
        }

        window.onload = function () {
            document.getElementById("findDoctorsBtn")
                .addEventListener("click", getUserLocation);
        };
    </script>

    <main>
        <div class="doctor-list">
            <div class="header-flex">
                <h1>Find Nearby Doctors</h1>
                <a href="{{ url_for('stat_doctors') }}" class="btn tips-btn">
                    Suggestions
                </a>
            </div>

            <p>Select the type of specialist you are looking for</p>

            <div class="doctor-type">
                <label>
                    <input type="radio" name="doctorType" value="cardiologist" checked>
                    Cardiologist ‚ù§
                </label>
                <label>
                    <input type="radio" name="doctorType" value="diabetes specialist">
                    Diabetologists ‚≠ï
                </label>
            </div>

            <p id="locationInfo"></p>

            <button id="findDoctorsBtn" class="btn consult-btn">
                Get My Location
            </button>

            <h2>Doctors in Your Area:</h2>
            <ul id="doctorsList" class="doctors"></ul>
        </div>
    </main>
</body>

</html>
